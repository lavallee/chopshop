#!/bin/bash
#
# chopshop-validate - Validate beads state matches chopshop expectations
#
# Usage: chopshop-validate [--fix]
#
# Checks:
# - All tasks have parent (epic) relationships
# - All tasks have model:* labels
# - All tasks have complexity:* labels
# - All tasks have phase-* labels
# - Descriptions follow expected structure
# - No orphaned dependencies
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

FIX_MODE=false
ERRORS=0
WARNINGS=0

usage() {
    echo "Usage: chopshop-validate [--fix]"
    echo ""
    echo "Validate beads state matches chopshop expectations."
    echo ""
    echo "Options:"
    echo "  --fix    Attempt to fix issues (not yet implemented)"
    echo ""
    exit 1
}

error() {
    echo -e "${RED}✗${NC} $1"
    ((ERRORS++))
}

warn() {
    echo -e "${YELLOW}!${NC} $1"
    ((WARNINGS++))
}

ok() {
    echo -e "${GREEN}✓${NC} $1"
}

info() {
    echo -e "${BLUE}→${NC} $1"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --fix)
            FIX_MODE=true
            shift
            ;;
        --help|-h)
            usage
            ;;
        *)
            echo "Unknown option: $1"
            usage
            ;;
    esac
done

# Check bd is installed
if ! command -v bd &> /dev/null; then
    echo -e "${RED}Error:${NC} Beads CLI (bd) not found."
    exit 1
fi

# Check .beads exists
if [ ! -d ".beads" ]; then
    echo -e "${RED}Error:${NC} No .beads directory found. Run 'bd init' first."
    exit 1
fi

echo "Validating beads state..."
echo ""

# Export current state
EXPORT_FILE=$(mktemp)
trap "rm -f $EXPORT_FILE" EXIT

bd export > "$EXPORT_FILE" 2>/dev/null

TOTAL=$(wc -l < "$EXPORT_FILE" | tr -d ' ')
EPICS=$(jq -s '[.[] | select(.issue_type == "epic")] | length' "$EXPORT_FILE")
TASKS=$(jq -s '[.[] | select(.issue_type == "task")] | length' "$EXPORT_FILE")

info "Found $TOTAL issues ($EPICS epics, $TASKS tasks)"
echo ""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Check 1: Tasks have parent relationships
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo "Checking parent relationships..."

ORPHAN_TASKS=$(jq -s '
    [.[] | select(.issue_type == "task") |
     select((.dependencies // []) | map(select(.type == "parent-child")) | length == 0) |
     .id] | join(", ")
' "$EXPORT_FILE" | tr -d '"')

if [ -n "$ORPHAN_TASKS" ] && [ "$ORPHAN_TASKS" != "" ]; then
    error "Tasks without parent epic: $ORPHAN_TASKS"
else
    ok "All tasks have parent relationships"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Check 2: Tasks have model:* labels
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo "Checking model labels..."

MISSING_MODEL=$(jq -s '
    [.[] | select(.issue_type == "task") |
     select((.labels // []) | map(select(startswith("model:"))) | length == 0) |
     select((.labels // []) | map(select(. == "checkpoint")) | length == 0) |
     .id] | join(", ")
' "$EXPORT_FILE" | tr -d '"')

if [ -n "$MISSING_MODEL" ] && [ "$MISSING_MODEL" != "" ]; then
    error "Tasks without model:* label: $MISSING_MODEL"
else
    ok "All tasks have model labels"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Check 3: Tasks have complexity:* labels
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo "Checking complexity labels..."

MISSING_COMPLEXITY=$(jq -s '
    [.[] | select(.issue_type == "task") |
     select((.labels // []) | map(select(startswith("complexity:"))) | length == 0) |
     select((.labels // []) | map(select(. == "checkpoint")) | length == 0) |
     .id] | join(", ")
' "$EXPORT_FILE" | tr -d '"')

if [ -n "$MISSING_COMPLEXITY" ] && [ "$MISSING_COMPLEXITY" != "" ]; then
    warn "Tasks without complexity:* label: $MISSING_COMPLEXITY"
else
    ok "All tasks have complexity labels"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Check 4: Tasks have phase-* labels
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo "Checking phase labels..."

MISSING_PHASE=$(jq -s '
    [.[] | select(.issue_type == "task") |
     select((.labels // []) | map(select(startswith("phase-"))) | length == 0) |
     .id] | join(", ")
' "$EXPORT_FILE" | tr -d '"')

if [ -n "$MISSING_PHASE" ] && [ "$MISSING_PHASE" != "" ]; then
    warn "Tasks without phase-* label: $MISSING_PHASE"
else
    ok "All tasks have phase labels"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Check 5: Descriptions have expected structure
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo "Checking description structure..."

MISSING_CONTEXT=$(jq -s '
    [.[] | select(.issue_type == "task") |
     select(.description != null) |
     select(.description | contains("## Context") | not) |
     select((.labels // []) | map(select(. == "checkpoint")) | length == 0) |
     .id] | join(", ")
' "$EXPORT_FILE" | tr -d '"')

if [ -n "$MISSING_CONTEXT" ] && [ "$MISSING_CONTEXT" != "" ]; then
    warn "Tasks without '## Context' in description: $MISSING_CONTEXT"
else
    ok "All task descriptions have Context section"
fi

MISSING_HINTS=$(jq -s '
    [.[] | select(.issue_type == "task") |
     select(.description != null) |
     select(.description | contains("## Implementation Hints") | not) |
     select((.labels // []) | map(select(. == "checkpoint")) | length == 0) |
     .id] | join(", ")
' "$EXPORT_FILE" | tr -d '"')

if [ -n "$MISSING_HINTS" ] && [ "$MISSING_HINTS" != "" ]; then
    warn "Tasks without '## Implementation Hints' in description: $MISSING_HINTS"
else
    ok "All task descriptions have Implementation Hints section"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Check 6: Model distribution summary
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo ""
echo "Model distribution:"

HAIKU_COUNT=$(jq -s '[.[] | select(.labels // [] | any(. == "model:haiku"))] | length' "$EXPORT_FILE")
SONNET_COUNT=$(jq -s '[.[] | select(.labels // [] | any(. == "model:sonnet"))] | length' "$EXPORT_FILE")
OPUS_COUNT=$(jq -s '[.[] | select(.labels // [] | any(. == "model:opus-4.5"))] | length' "$EXPORT_FILE")

echo "  model:haiku    $HAIKU_COUNT tasks"
echo "  model:sonnet   $SONNET_COUNT tasks"
echo "  model:opus-4.5 $OPUS_COUNT tasks"

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Summary
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}All checks passed!${NC}"
    exit 0
elif [ $ERRORS -eq 0 ]; then
    echo -e "${YELLOW}Validation complete with $WARNINGS warning(s)${NC}"
    exit 0
else
    echo -e "${RED}Validation failed with $ERRORS error(s) and $WARNINGS warning(s)${NC}"
    exit 1
fi
